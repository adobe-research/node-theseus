<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
<script>
function div(text) {
	var dom = document.createElement("p");
	dom.appendChild(document.createTextNode(text));
	return dom;
}

function Connection() {
	this.socket = new WebSocket("ws://localhost:8888/");
	this.socket.onerror = this._onerror.bind(this);
	this.socket.onopen = this._onopen.bind(this);
	this.socket.onmessage = this._onmessage.bind(this);
	this.socket.onclose = this._onclose.bind(this);
	this.connected = new $.Deferred();
	this._nextRequestIndex = 0;
	this._requests = {};
}
Connection.prototype = {
	_onerror: function () {
		document.body.appendChild(div("error"));
		this.connected.reject();
		this._rejectAllPending();
	},
	_onopen: function () {
		document.body.appendChild(div("open"));
		this.connected.resolve();
	},
	_onmessage: function (msg) {
		var resp = JSON.parse(msg.data);
		if (resp.id in this._requests) {
			this._requests[resp.id].resolve(resp.data);
			delete this._requests[resp.id];
		}
	},
	_onclose: function () {
		document.body.appendChild(div("close"));
		this.connected.reject();
		this._rejectAllPending();
	},
	_rejectAllPending: function () {
		for (var i in this._requests) {
			this._requests[i].reject();
		}
		this._requests = {};
	},
	request: function (name, args) {
		var deferred = new $.Deferred();
		var idx = this._nextRequestIndex++;
		this.socket.send(JSON.stringify({
			name: name,
			arguments: args || [],
			id: idx
		}));
		this._requests[idx] = deferred;
		return deferred.promise();
	},
}

window.onload = function () {
	var conn = new Connection();
	conn.connected.done(function () {
		conn.request("trackHits").done(function (handle) {
			setInterval(function () {
				conn.request("hitCountDeltas", [handle]).done(function (deltas) {
					document.body.appendChild(div(JSON.stringify(deltas)));
				});
			}, 1000);
		});
	});
}
</script>
